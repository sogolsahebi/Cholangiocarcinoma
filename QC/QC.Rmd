---
title: "Analysis of SE_CCA Summarized Experiment."
author: "Nasim Bondar Sahebi"
date: "2023-12-20"
output:
  html_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```


# Load libraries.

```{r  load libraries}

library(SummarizedExperiment)
library(dplyr)
library(ggplot2)
library(knitr)
library(DT)

```


# Data Loading and Preparation

## Load Gene Summarized Experiment Data

#### Data Overview

  - **Paper name **:  Genomic characterization of cholangiocarcinoma with autoimmune etiologies
  - **Patient samples **: 33 
  - **RNA sequencing (RNA-seq)**: 33 patients
  - **Non-autoimmune **:  25 patients
  - **Non-autoimmune **:  15 patients
  

Load the Summarized Experiment .rds file (SE_CCA.rds), extract clinical and expression data (TPM), along with annotations, and prepare the gene expression data for analysis.

```{r summery load-data}

# Load your SE result and extract clinical data , expression data and annotation

# Load SE obj
se <- readRDS("~/BHK lab/kevin Project/Cholangiocarcinoma/data/SE_CCA.rds")

# Extract Clinical data 
clin <- data.frame(colData(se))

# Extract the expression data
expr_tpm <- assays(se)[["expr_tpm"]]

# Extract the annotation
annot <- data.frame(rowData(se))

# Display first few rows of the dataset
DT::datatable(expr_tpm[1:8, 1:8])

```

# Data Preparation 

Preparing expression data (RNA-seq) for analysis:

1. **Restrict expression data to protein-coding genes.**
2. **Remove low/zero expression genes.**"


```{r Data Preparation }

# Step 1: Restrict to Protein-Coding Genes.
annot_proteincoding <- annot[annot$gene_type == "protein_coding",] # 19205 protein coding genes.
expr_tpm <- expr_tpm[rownames(expr_tpm) %in% rownames(annot_proteincoding),]


# Step 2: Filter Low/Zero Expression Genes]

#data is log2(TPM+1)
r <- as.numeric(apply(expr_tpm, 1, function(i) sum(round(i, 6) == round(log2(1), 6))))

# Get the indices of rows to remove
remove <- which(r > dim(expr_tpm)[2] * 0.05)

# Remove rows from the matrix
expr_tpm <- expr_tpm[-remove, ]

expr_tpm <- t(expr_tpm)

DT::datatable(expr_tpm[1:8, 1:8])
```

# Descriptive analysis

Evaluate Differences in Clinicodemographic and Staging Variables

- For continuous variables (e.g., age), we calculated the median and IQR and assessed associations using the Wilcoxon test.

- For discrete/categorical variables (e.g., sex, stage), we determined frequency and percentage distributions and assessed associations using the Chi-squared or Fisher exact test.



```{r Descriptive analysis}


# Set 'y' and 'n' to 'Autoimmune' and 'Non-Autoimmune' within the dataframe
clin$psc_ibd[clin$psc_ibd == 'y'] <- 'Autoimmune'
clin$psc_ibd[clin$psc_ibd == 'n'] <- 'Non-Autoimmune'

# 1. Age

# Summarize age statistics (count,Mean(SD), Median(IQR), Min,Max) for each psc_ibd group.
summary_stats <- summarise(
  group_by(clin, psc_ibd),
  count = n(),
  Mean_SD = sprintf("%.2f(%.2f)", mean(age, na.rm = TRUE), sd(age, na.rm = TRUE)),
  Median_IQR = sprintf("%.2f(%.2f)", median(age, na.rm = TRUE), IQR(age, na.rm = TRUE)),
  Min_Max = sprintf("%.2f,%.2f", min(age, na.rm = TRUE), max(age, na.rm = TRUE))
)

# Store statistics for Auto and Non-Auto for later use
auto_count <- summary_stats$count[summary_stats$psc_ibd == "Autoimmune"]
non_auto_count <- summary_stats$count[summary_stats$psc_ibd == "Non-Autoimmune"]

# Visualize your data.

# Plotting boxplot for age distributions
ggplot(clin, aes(x = psc_ibd, y = age, color = psc_ibd)) +
  geom_boxplot() +
  scale_color_manual(values = c("Autoimmune" = "#00AFBB", "Non-Autoimmune" = "#E7B800")) +
  labs(y = "Age", x = "PSC-IBD")

# Perform two-sample Wilcoxon test
res <- wilcox.test(age ~ psc_ibd, data = clin, exact = FALSE)
p_value_age <- res$p.value

# 2. Sex

# Perform Fisher's Exact Test for 'sex' and 'psc_ibd'
contingency_sex <- table(clin$sex, clin$psc_ibd)
p_value_sex <- fisher.test(contingency_sex)$p.value

# Calculate and format percentages for Sex
sex_stats <- apply(contingency_sex, 2, function(x) sprintf("%d (%.1f%%)", x, 100 * x / sum(x)))

# Perform Fisher's Exact Test for 'location' and 'psc_ibd'
contingency_loc <- table(clin$location, clin$psc_ibd)
p_value_loc <- fisher.test(contingency_loc)$p.value

# Calculate and format percentages for Location
location_stats <- apply(contingency_loc, 2, function(x) sprintf("%d (%.1f%%)", x, 100 * x / sum(x)))

# Perform Fisher's Exact Test for 'stage' and 'psc_ibd'
clin$stage <- with(clin, ifelse(stage %in% c("IIIA", "IIIB", "IIIC"), "III",
                                ifelse(stage %in% c("IVA", "IVB"), "IV", stage)))

contingency_stage <- table(clin$stage, clin$psc_ibd)
p_value_stage <- fisher.test(contingency_stage)$p.value

# Calculate and format percentages for Stage
stage_stats <- apply(contingency_stage, 2, function(x) sprintf("%d (%.1f%%)", x, 100 * x / sum(x)))

# Combine all statistics into a data frame for the table
result <- data.frame(
  Characteristics = c("Age", "Mean (SD)", "Median (IQR)", "Min, Max", "", "Sex", "F", "M", "", "Location", "dCCA", "GBC", "iCCA", "pCCA", "", "Stage", "II", "III", "IV"),
  `Autoimmune (n=14)` = c("", summary_stats$Mean_SD[1], summary_stats$Median_IQR[1], summary_stats$Min_Max[1], "", "", sex_stats[1, 1], sex_stats[2, 1], "", "", location_stats[1, 1], location_stats[2, 1], location_stats[3, 1], location_stats[4, 1], "", "", stage_stats[1, 1], stage_stats[2, 1], stage_stats[3, 1]),
  `Non-Autoimmune (n=19)` = c("", summary_stats$Mean_SD[2], summary_stats$Median_IQR[2], summary_stats$Min_Max[2], "", "", sex_stats[1, 2], sex_stats[2, 2], "", "", location_stats[1, 2], location_stats[2, 2], location_stats[3, 2], location_stats[4, 2], "", "", stage_stats[1, 2], stage_stats[2, 2], stage_stats[3, 2]),
  `P value` = c(p_value_age, "", "", "", "", p_value_sex, "", "", "", p_value_loc, "", "", "", "", "", p_value_stage, "", "", "")
)

table_html <- kable(
    result, 
    format = "html", 
    caption =" Table 1: Clinicodemographic and Staging Characteristics at Baseline (AJCC 8th Edition)", 
    escape = FALSE,
    table.attr = 'style="width:100%; overflow-x:scroll; overflow-y:scroll; max-height:400px;"'
)

table_html

```


